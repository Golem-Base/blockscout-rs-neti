syntax = "proto3";

package blockscout.golemBaseIndexer.v1;

option go_package = "github.com/Golem-Base/blockscout-rs-neti/golem-base-indexer";


service GolemBaseIndexerService {
  rpc GetEntity(GetEntityRequest) returns (FullEntity);
  rpc GetOperation(GetOperationRequest) returns (Operation);
  
  rpc ListEntities(ListEntitiesRequest) returns (ListEntitiesResponse);
  rpc ListOperations(ListOperationsRequest) returns (ListOperationsResponse);

  rpc CountOperations(CountOperationsRequest) returns (CountOperationsResponse);
}

message GetEntityRequest {
  string key = 1;
}

message GetOperationRequest {
  string tx_hash = 1;
  uint64 index = 2;
}

message ListEntitiesRequest {
  // FIXME add filtering & paging options
}

message ListEntitiesResponse {
  repeated Entity items = 1;
  // FIXME add pagination metadata
}

message ListOperationsRequest {
  OperationType operation = 1;
  optional uint64 page = 2;
  optional uint64 page_size = 3;
  optional string block_hash = 4;
  optional string transaction_hash = 5;
  optional string sender = 6;
  optional string entity_key = 7;
}

message ListOperationsResponse {
  repeated Operation items = 1;
  Pagination pagination = 2;
}

message Pagination {
  uint64 page = 1;
  uint64 page_size = 2;
  uint64 total_pages = 3;
  uint64 total_items = 4;
}

message CountOperationsRequest {
  optional uint64 page = 1;
  optional uint64 page_size = 2;
  optional string block_hash = 3;
  optional string transaction_hash = 4;
  optional string sender = 5;
  optional string entity_key = 6;
}

message CountOperationsResponse {
  uint64 create_count = 1;
  uint64 update_count = 2;
  uint64 delete_count = 3;
  uint64 extend_count = 4;
}

enum EntityStatus {
  Active = 0;
  Deleted = 1;
  Expired = 2;
}

message Entity {
  string key = 1;
  optional string data = 2;
  EntityStatus status = 3;

  optional string created_at_tx_hash = 4;
  string last_updated_at_tx_hash = 5;
  uint64 expires_at_block_number = 6;
}

message StringAnnotation {
  string key = 1;
  string value = 2;
}

message NumericAnnotation {
  string key = 1;
  uint64 value = 2;
}

message FullEntity {
  string key = 1;
  optional string data = 2;
  optional uint64 data_size = 3;
  EntityStatus status = 4;

  repeated StringAnnotation string_annotations = 5;
  repeated NumericAnnotation numeric_annotations = 6;

  optional string created_at_tx_hash = 7;
  optional string created_at_operation_index = 8;
  optional uint64 created_at_block_number = 9;
  optional string created_at_timestamp = 10;

  uint64 expires_at_block_number = 11;
  string expires_at_timestamp = 12;

  string owner = 13;
  string gas_used = 14;
  string fees_paid = 15;
}

enum OperationType {
  CREATE = 0;
  UPDATE = 1;
  DELETE = 2;
  EXTEND = 3;
}

message Operation {
  string entity_key = 1;
  string sender = 2;
  OperationType operation = 3;
  optional string data = 4;
  optional uint64 btl = 5;
  string block_hash = 6;
  string transaction_hash = 7;
  uint64 index = 8;
}
