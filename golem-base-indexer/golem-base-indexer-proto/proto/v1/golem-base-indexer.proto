syntax = "proto3";

package blockscout.golemBaseIndexer.v1;

option go_package = "github.com/Golem-Base/blockscout-rs-neti/golem-base-indexer";


service GolemBaseIndexerService {
  rpc GetEntity(GetEntityRequest) returns (FullEntity);
  rpc GetEntityHistory(GetEntityHistoryRequest) returns (GetEntityHistoryResponse);
  rpc GetOperation(GetOperationRequest) returns (EntityHistoryEntry);
  
  rpc ListEntities(ListEntitiesRequest) returns (ListEntitiesResponse);
  rpc ListOperations(ListOperationsRequest) returns (ListOperationsResponse);

  rpc CountEntities(CountEntitiesRequest) returns (CountEntitiesResponse);
  rpc CountOperations(CountOperationsRequest) returns (CountOperationsResponse);

  rpc AddressStats(AddressStatsRequest) returns (AddressStatsResponse);
  rpc ListBiggestSpenders(ListBiggestSpendersRequest) returns (ListBiggestSpendersResponse);
  rpc BlockStats(BlockStatsRequest) returns (BlockStatsResponse);
  rpc ListEntitiesByBtl(ListEntitiesByBtlRequest) returns (ListEntitiesByBtlResponse);
  rpc ListAddressByEntitiesOwned(ListAddressByEntitiesOwnedRequest) returns (ListAddressByEntitiesOwnedResponse);
  rpc ListAddressByDataOwned(ListAddressByDataOwnedRequest) returns (ListAddressByDataOwnedResponse);
  rpc ListLargestEntities(ListLargestEntitiesRequest) returns (ListLargestEntitiesResponse);
  rpc ListEffectivelyLargestEntities(ListEffectivelyLargestEntitiesRequest) returns (ListEffectivelyLargestEntitiesResponse);
  rpc ListAddressByEntitiesCreated(ListAddressByEntitiesCreatedRequest) returns (ListAddressByEntitiesCreatedResponse);

  rpc ChartDataUsage(ChartDataUsageRequest) returns (ChartDataUsageResponse);
}

message AddressStatsRequest {
  string address = 1;
}

message AddressStatsResponse {
  uint64 created_entities = 1;
  uint64 active_entities = 2;
  uint64 size_of_active_entities = 3;
  uint64 total_transactions = 4;
  uint64 failed_transactions = 5;
  CountOperationsResponse operations_counts = 6;
}

message GetEntityRequest {
  string key = 1;
}

message GetEntityHistoryRequest {
  string key = 1;
  optional uint64 page = 2;
  optional uint64 page_size = 3;
}

message GetOperationRequest {
  string tx_hash = 1;
  uint64 op_index = 2;
}

message ListEntitiesRequest {
  optional uint64 page = 1;
  optional uint64 page_size = 2;
  EntityStatus status = 3;
  optional string string_annotation_key = 4;
  optional string string_annotation_value = 5;
  optional string numeric_annotation_key = 6;
  optional string numeric_annotation_value = 7;
}

message ListEntitiesResponse {
  repeated Entity items = 1;
  Pagination pagination = 2;
}

message ListOperationsRequest {
  OperationType operation = 1;
  optional uint64 page = 2;
  optional uint64 page_size = 3;
  optional string block_number_or_hash = 4;
  optional string transaction_hash = 5;
  optional string sender = 6;
  optional string entity_key = 7;
}

message ListOperationsResponse {
  repeated Operation items = 1;
  Pagination pagination = 2;
}

message Pagination {
  uint64 page = 1;
  uint64 page_size = 2;
  uint64 total_pages = 3;
  uint64 total_items = 4;
}

message CountOperationsRequest {
  optional string block_number_or_hash = 1;
  optional string transaction_hash = 2;
  optional string sender = 3;
  optional string entity_key = 4;
}

message CountOperationsResponse {
  uint64 create_count = 1;
  uint64 update_count = 2;
  uint64 delete_count = 3;
  uint64 extend_count = 4;
}

message CountEntitiesRequest {
  EntityStatus status = 1;
  optional string string_annotation_key = 2;
  optional string string_annotation_value = 3;
  optional string numeric_annotation_key = 4;
  optional string numeric_annotation_value = 5;
}

message CountEntitiesResponse {
  uint64 count = 1;
}

enum EntityStatus {
  ACTIVE = 0;
  DELETED = 1;
  EXPIRED = 2;
}

message Entity {
  string key = 1;
  optional string data = 2;
  EntityStatus status = 3;

  optional string created_at_tx_hash = 4;
  string last_updated_at_tx_hash = 5;
  uint64 expires_at_block_number = 6;
}

message EntityWithExpTimestamp {
  string key = 1;
  optional string data = 2;
  EntityStatus status = 3;
  optional string created_at_tx_hash = 4;
  string last_updated_at_tx_hash = 5;
  uint64 expires_at_block_number = 6;
  optional string expires_at_timestamp = 7;
}

message StringAnnotation {
  string key = 1;
  string value = 2;
}

message NumericAnnotation {
  string key = 1;
  uint64 value = 2;
}

message StringAnnotationWithRelations {
  string key = 1;
  string value = 2;
  uint64 related_entities = 3;
}

message NumericAnnotationWithRelations {
  string key = 1;
  uint64 value = 2;
  uint64 related_entities = 3;
}

message FullEntity {
  string key = 1;
  optional string data = 2;
  optional uint64 data_size = 3;
  EntityStatus status = 4;

  repeated StringAnnotationWithRelations string_annotations = 5;
  repeated NumericAnnotationWithRelations numeric_annotations = 6;

  optional string created_at_tx_hash = 7;
  optional string created_at_operation_index = 8;
  optional uint64 created_at_block_number = 9;
  optional string created_at_timestamp = 10;

  uint64 expires_at_block_number = 11;
  optional string expires_at_timestamp = 12;

  optional string owner = 13;
  string gas_used = 14;
  string fees_paid = 15;

  string updated_at_tx_hash = 16;
  string updated_at_operation_index = 17;
  uint64 updated_at_block_number = 18;
  string updated_at_timestamp = 19;
}

enum OperationType {
  CREATE = 0;
  UPDATE = 1;
  DELETE = 2;
  EXTEND = 3;
}

message Operation {
  string entity_key = 1;
  string sender = 2;
  OperationType operation = 3;
  optional string data = 4;
  optional uint64 btl = 5;
  string block_hash = 6;
  string transaction_hash = 7;
  uint64 index = 8;
  string gas_used = 9;
  string fees_paid = 10;
  uint64 block_number = 11;
}

message GetEntityHistoryResponse {
  repeated EntityHistoryEntry items = 1;
  Pagination pagination = 2;
}

message EntityHistoryEntry {
  string entity_key = 1;
  uint64 block_number = 2;
  string block_hash = 3;
  string transaction_hash = 4;
  uint64 tx_index = 5;
  uint64 op_index = 6;
  string block_timestamp = 7;
  string sender = 8;
  OperationType operation = 9;
  optional string btl = 10;
  optional string data = 11;
  optional string prev_data = 12;
  EntityStatus status = 13;
  optional string prev_status = 14;
  uint64 expires_at_block_number = 15;
  optional uint64 prev_expires_at_block_number = 16;
  string gas_used = 17;
  string fees_paid = 18;
  optional string expires_at_timestamp = 19;
  optional string prev_expires_at_timestamp = 20;
}

message ListBiggestSpendersRequest {
  optional uint64 page = 1;
  optional uint64 page_size = 2;
}

message ListBiggestSpendersResponse {
  repeated BiggestSpender items = 1;
  Pagination pagination = 2;
}

message BiggestSpender {
  uint64 rank = 1;
  string address = 2;
  string total_fees = 3;
}

message BlockStatsRequest {
  string block_number = 1;
}

message BlockStatsResponse {
  BlockStatsCounts counts = 1;
  BlockStatsStorage storage = 2;
}

message BlockStatsCounts {
  uint64 create_count = 1;
  uint64 update_count = 2;
  uint64 expire_count = 3;
  uint64 delete_count = 4;
  uint64 extend_count = 5;
}

message BlockStatsStorage {
  uint64 block_bytes = 1;
  uint64 total_bytes = 2;
}

message ListEntitiesByBtlRequest {
  optional uint64 page = 1;
  optional uint64 page_size = 2;
}

message ListEntitiesByBtlResponse {
  repeated EntityWithExpTimestamp items = 1;
  Pagination pagination = 2;
}

message ListAddressByEntitiesOwnedRequest {
  optional uint64 page = 1;
  optional uint64 page_size = 2;
}

message ListAddressByEntitiesOwnedResponse {
  repeated AddressByEntitiesOwned items = 1;
  Pagination pagination = 2;
}

message AddressByEntitiesOwned {
  string address = 1;
  uint64 entities_count = 2;
}

message ListAddressByDataOwnedRequest {
  optional uint64 page = 1;
  optional uint64 page_size = 2;
}

message ListAddressByDataOwnedResponse {
  repeated AddressByDataOwned items = 1;
  Pagination pagination = 2;
}

message AddressByDataOwned {
  string address = 1;
  uint64 data_size = 2;
}

message ListLargestEntitiesRequest {
  optional uint64 page = 1;
  optional uint64 page_size = 2;
}

message ListLargestEntitiesResponse {
  repeated EntityDataSize items = 1;
  Pagination pagination = 2;
}

message EntityDataSize {
  string entity_key = 1;
  uint64 data_size = 2;
}

message ListEffectivelyLargestEntitiesRequest {
  optional uint64 page = 1;
  optional uint64 page_size = 2;
}

message ListEffectivelyLargestEntitiesResponse {
  repeated EntityEffectiveDataSize items = 1;
  Pagination pagination = 2;
}

message EntityEffectiveDataSize {
  string entity_key = 1;
  uint64 data_size = 2;
  uint64 lifespan = 3; // lifespan in blocks
}

message ListAddressByEntitiesCreatedRequest {
  optional uint64 page = 1;
  optional uint64 page_size = 2;
}

message ListAddressByEntitiesCreatedResponse {
  repeated AddressByEntitiesCreated items = 1;
  Pagination pagination = 2;
}

message AddressByEntitiesCreated {
  uint64 rank = 1;
  string address = 2;
  uint64 entities_created_count = 3;
}

enum ChartResolution {
  DAY = 0;
  HOUR = 1;
}

message ChartInfo {
  string id = 1;
  string title = 2;
  string description = 3;
}

message ChartPoint {
  string date = 1;
  string date_to = 2;
  string value = 3;
}

message ChartDataUsageRequest {
  optional string from = 1;
  optional string to = 2;
  ChartResolution resolution = 3;
}

message ChartDataUsageResponse {
  repeated ChartPoint chart = 1;
  ChartInfo info = 2;
}
